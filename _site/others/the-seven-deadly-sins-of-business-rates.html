<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.53">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>The seven deadly sins of business rates – Christian Spence</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Christian Spence</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../biography.html"> 
<span class="menu-text">Biography</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research-publications.html"> 
<span class="menu-text">Research &amp; Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications-elsewhere.html"> 
<span class="menu-text">Publications elsewhere</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://economic-analytics.co.uk"> 
<span class="menu-text">Economic Analytics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/christianspence.co.uk"> 
<span class="menu-text">bsky</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-twitter-x" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-twitter-x" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-twitter-x">    
        <li>
    <a class="dropdown-item" href="https://x.com/ChristianSpence">
 <span class="dropdown-text">Christian Spence</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://x.com/EconAnalyticsUK">
 <span class="dropdown-text">Economic Analytics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-linkedin" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-linkedin">    
        <li>
    <a class="dropdown-item" href="https://linkedin.com/in/christianspence">
 <span class="dropdown-text">Christian Spence</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://linkedin.com/company/economic-analytics">
 <span class="dropdown-text">Economic Analytics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ChristianSpence">
 <span class="dropdown-text">Christian Spence</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/economic-analytics">
 <span class="dropdown-text">Economic Analytics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ChristianSpence/christianspence.co.uk">
 <span class="dropdown-text">Website source code</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The seven deadly sins of business rates</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><em>This blog was first published in an abridged format by British Chambers of Commerce in March 2017.</em></p>
<p>Whilst nobody likes a tax, business rates is one that people love to hate. As a Fellow of British Chambers of Commerce (BCC) leading on the reform of business rates for two-and-a-half years, I’ve heard more nightmare stories from members than for any other issue, and have spent hours in rooms in Whitehall working through proposals with other business groups, local authorities, HM Treasury, the Department for Communities and Local Government (DCLG) and the Valuations Office Agency (VOA). I often say, and only partially in jest, that I started a 12-month project over two years ago and think I may now be approaching the half-way point.</p>
<p>The history of business rates is a long one. Many know about the large changes to business rates that took place in 1990 under the Thatcher local government reforms when the level of rates was nationalised, but not many know that the system dates back a lot further: the Act for the Relief of the Poor 1601, passed under Elizabeth I, is the first piece of legislation.</p>
<p>There’s two other things from deep history I’d also like to reference here. Firstly, from the 17th-century, the words of Jean-Baptiste Colbert, minister of finance for King Louis XIV of France, and secondly, from the 18th-century, the wisdom of Scotland’s own father of economics, Adam Smith. Colbert said that “the art of taxation consists in so plucking the goose as to obtain the largest amount of feathers with the least possible amount of hissing”, and Smith laid out what he considered were fundamental principles of economic taxation: equity, certainty, convenience and economy. It is highly questionable whether the UK’s business rates system meets any of the above.</p>
<section id="how-did-the-issue-start" class="level2">
<h2 class="anchored" data-anchor-id="how-did-the-issue-start">How did the issue start?</h2>
<p>As an issue, business rates really came to the fore after the recession. Commercial property prices tumbled as businesses struggled or failed, plenty a strong downward movement on rents. Companies were often able to renegotiate leases as supply increased and demand softened. But business rates were not only locked at their pre-recession level, remaining as a fixed percentage of the assumed market value of the property at the previous revaluation in 2003, but increased further in 2010 when business rates became a higher percentage of higher values, calculated against rents two years previously in April 2008, about as close to the top of the overheated market as it was possible to be. Wanting to minimise large changes to the rates payable, the scheduled revaluation for 2015 was delayed, giving the system another two years to become even more out of sync with the real world.</p>
<p>In April, the changes in the UK commercial property market since 2008 will be passed into the business tax system in one go (albeit with some limited transitional arrangements). The result of that has been clear in the press over the past few weeks, as the house of commons passed its Brexit bill and then ran off for half-term, allowing a media frenzy on rates to emerge with little comment from government ministers, showing that Colbert’s principle is being violated: the goose is hissing – loudly.</p>
</section>
<section id="calling-for-reform" class="level2">
<h2 class="anchored" data-anchor-id="calling-for-reform">Calling for reform</h2>
<p>Working with its members, BCC developed seven key principles of the current system which require fundamental reform.</p>
<section id="above-the-line" class="level3">
<h3 class="anchored" data-anchor-id="above-the-line">1. Above the line</h3>
<p>Business rates is an input tax that it is payable regardless of turnover, profit, or ability to pay. Government policy is driving up input costs to businesses, whether through environmental taxes, increased minimum wages, auto-enrolment for pensions, higher employer national insurance or the forthcoming apprenticeship levy. At the same time, output taxes, particularly corporation tax, have been falling steeply, so revenue raised from business increasingly comes from the input side, burdening business regardless of its success. This violates Smith’s equity principle, that tax should be “… in proportion to their respective abilities, that is, in proportion to their revenue …”.</p>
</section>
<section id="predictability-of-income" class="level3">
<h3 class="anchored" data-anchor-id="predictability-of-income">2. Predictability of income</h3>
<p>Business rates is neither pro-cyclical or counter-cyclical. Instead, it’s how-much-would-you-like-to-raise-next-year-Mr-Chancellor-cyclical. The uprating of the national multiplier each year, currently at RPI but expected to change to CPI in 2020, means that government revenue from this tax on rental values increases every year, even if rental values fall. It has an in-built escalator, something that when applied to fuel infuriates everyone, but slips by here with little issue. It’s just about the only tax in HM Treasury’s army that does this and it’s hard to see why it should continue. Of course, it’s convenient for government, but meaningless for business. See the canon of certainty above for Smith’s view. Ours is that indexing should ideally be abolished entirely, allowing the system to flex with the market.</p>
</section>
<section id="economically-unresponsive" class="level3">
<h3 class="anchored" data-anchor-id="economically-unresponsive">3. Economically unresponsive</h3>
<p>The slow frequency of revaluations (normally every five years, but currently seven) means rents and rates become disconnected over time. This can work in companies’ favour, and arguably that has happened in place like London since 2008, where rents have risen much faster than rates, but overall it means that areas with weaker property markets subsidies those with faster economic growth. In this sense, this partially violates Smith’s canon of certainty, where tax payable “… should be certain and not arbitrary”. A system which levies a percentage of what your property’s value was, or was thought to be at a previous time, is not ideal. The debates around Council Tax valuations go to the heart of this exact problem as well. Our view? Speed up the revaluations to keep up with the market, but you’ll have to change the system, because …</p>
</section>
<section id="administrationally-complex" class="level3">
<h3 class="anchored" data-anchor-id="administrationally-complex">4. Administrationally complex</h3>
<p>It’s hard to get across just how bureaucratic this system is. If you operate a large site with a variety of uses, e.g.&nbsp;office space, toilets, kitchens, reception, warehouse, yard, factory, and have major plant and machinery including such modern-fripperies as air conditioning and micro generation, your valuation formula may not just run to dozens of line, but dozens of pages. An extra x% for one thing, subtract y% for another. It’s insane, and costs a fortune. It also generates a lot of appeals – the 2010 revaluation resulted in over a million appeals. When a system generates tax bills that nearly one-in-two payers feel the need to dispute, there’s something wrong. There are now so many appeals, that the back-log is nearly 300,000.</p>
<p>Each of those businesses is required to pay these rates, every year, until the appeal is resolved or rejected, meaning many will pay more than they should up to seven years after the valuation was first arrived at. Smith’s third canon of convenience, that tax “…should be levied in such a manner … that it affords the maximum convenience to the tax payer”. It’s hard to see how this is convenient. Also, the costs of centrally valuing every property (and more besides), only to give 100% relief to around to one-third of them isn’t efficient. That’s why we’ve argued for a self-exemption for the bottom-third of properties. Just submit your lease details, show that it’s below the level, and nobody needs to visit you and measure how big your toilet space is. That helps us get in line with Smith’s canon of economy, too: the cost of collection should be a minimum.</p>
</section>
<section id="perverse-incentives" class="level3">
<h3 class="anchored" data-anchor-id="perverse-incentives">5. Perverse incentives</h3>
<p>The administrational complexity caused by including productive investments in the valuation creates perverse incentives. Why improve your premises if you’re going to be taxed on the increase in value? Why invest in machinery if it will add to your tax bill at the next revaluation? And it also creates odd incentives on the recycling of government money. Want to follow government advice and decarbonise your energy supply to try and reclaim some of those environmental input taxes I mentioned earlier? Go ahead, and government will subsidise your investment through schemes available from the Department for Business, Energy and Industrial Strategy (BEIS), but DCLG will come along later and tax you for doing so. So we have a system where BEIS levies taxes on your energy and then gives you subsidies to change your behaviour, but if you do, VOA will come and visit you to work out its value and ask DCLG to tax you on it. This does not meet any criteria of tax efficiency. See Smith’s canon number three.</p>
</section>
<section id="disconnect-between-business-and-local-government" class="level3">
<h3 class="anchored" data-anchor-id="disconnect-between-business-and-local-government">6. Disconnect between business and local government</h3>
<p>One of the most common complaints about business rates is that companies simply don’t know what it’s there for or who receives it. “I don’t even get my bins emptied!” is a common response. Your local authority bills you, historically sending it all (now just half) to Whitehall who keep some then send it back to local authorities under a complex formula linked to deprivation and need. The system lacks significant transparency and the tax causes resentment between business and local government. The move to 100% retention by 2020 (though some areas will start a pilot this April) will set out a framework where this relationship could be improved, but it won’t happen on its own. For that to occur, there will need to be significant engagement between local authorities and their rate payers, and things like infrastructure levies may help, but there is a lot of work to do. It’s also questionable how much additional revenue full retention will allow for local government, but that shouldn’t stop this: the bigger principle here is restoring local accountability and both empowering spending decisions to be taken locally, and encouraging it to be done so openly.</p>
</section>
<section id="large-by-comparison" class="level3">
<h3 class="anchored" data-anchor-id="large-by-comparison">7. Large by comparison</h3>
<p>This has been the big sticking point in reform. Government, as part of its ongoing fiscal consolidation, has insisted that any changes to business rates must be revenue neutral, i.e.&nbsp;however much it raises before the reforms, it must raise afterwards (plus indexation, of course). This means that the winners and losers are amplified, as the rules make this a zero-sum game. As government has been happy to cut revenue by lowering corporation tax, clearly this is not just a cash issue. The challenge, of course, is that business rates is so entwined in the local government finance system that large changes to revenue and the system overall would require large-scale reform of local government and local government finance. Eric Pickles, when Secretary of State for DCLG, said there was a pearl-handled revolver in his drawer for anyone who suggested such a thing. That gives you a pretty good idea of how interested government would be in genuinely tackling this properly, from the ground up.</p>
<p>But there’s another dimension to this which I suspect is where the blocks on radical reform come. Basically, it raises too much money. At £26bn, the UK raises a larger share of taxation from property taxes than any other developed economy, and around double the OECD average. That, combined with its complex twinning with local government, means even small changes can have a disproportionate effect on the spending power of town halls. Corporation tax can be changed easily as it goes to central government and mostly funds central spending so large changes can be absorbed. I fear that not only does the fiscal neutrality argument stop serious reform, it actually makes the matter worse. The larger the revenue share gets, the harder reform in the future becomes.</p>
</section>
</section>
<section id="efficient-tax-theory" class="level2">
<h2 class="anchored" data-anchor-id="efficient-tax-theory">Efficient tax theory</h2>
<p>Those are the key areas showing why we want reform, but there’s one last thing I want to touch on. There have been a number of economists over the past few weeks – mostly those I take seriously as good quality academics and practitioners of efficient tax theory and good quality public policy and who I often agree with – who have put forward the argument that business rates, as a tax on property value, is broadly efficient and has a number of good comparisons with a land value tax (LVT), something which many economists would ultimately prefer. Their argument often includes comments that increasing something’s value should increase the nominal amount of tax payable, and that, in its similarities to an LVT, broadly encourages economically efficient use of a finite resource like land.</p>
<p>I feel that there are some elements of truth in this, but also that it mostly obfuscates, or entirely misses, the areas where the similarities to a LVT are weakest. Firstly, business rates is a tax on property value, not land value. That means the relationship is close, but not very, and varies hugely depending on the use of the property itself. The vagaries of valuing large sites on the central list such as power stations show how highly approximate this process can be. Secondly, plant and machinery is included in the valuation, which would have impacts on the property value but not the land value. This is the area where I feel the difference between business rates and an LVT is the largest and, in arguing for the removal of plant and machinery, we specifically included a comment that in doing so, you would allow the business rates system to operate in a way more closely related to an LVT. Finally, there are two ways of looking at a tax – deadweight costs of the system itself, and the level at which it operates.</p>
<p>I’ve outlined above the problems with the first of these, that the system simply isn’t efficient, but the rate at which it is levied matters too. A key piece of economic tax theory – the Laffer curve – speaks directly to this in that there are optimum rates of taxation for both revenue raising and economic distortion. Here is where business rates, compared to either an LVT or to Council Tax – another example of a property value tax – sit as an outlier. No-one would countenance Council Tax or an LVT being set at the rate business rates currently are. The rate for 2017/18 is likely to be over 50%, meaning the tax take on property value is inordinately large. Combine this with the all too clear failings of the UK’s planning system to provide adequate land in the right areas with the right permissions, and you’re effectively levying one of the highest rates of tax in the UK economy on one of the most poorly designed systems with little ability to react to market conditions.</p>
<p>Put all this together, and it’s no wonder that Colbert’s goose is hissing.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>